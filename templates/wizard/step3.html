{% extends "base.html" %}

{% block title %}Step 3: Publications - WordPress Site Generator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <!-- Step Indicator -->
        <div class="step-indicator mb-4">
            <div class="step completed">
                <div class="h5">1</div>
                <small>Personal Info</small>
            </div>
            <div class="step completed">
                <div class="h5">2</div>
                <small>Biography</small>
            </div>
            <div class="step active">
                <div class="h5">3</div>
                <small>Publications</small>
            </div>
            <div class="step">
                <div class="h5">4</div>
                <small>Gallery</small>
            </div>
            <div class="step">
                <div class="h5">5</div>
                <small>Preview</small>
            </div>
        </div>

        <h1>Step 3: Publications</h1>
        <p class="lead">Add your publications. You can upload a BibTeX file, paste BibTeX content, or manually enter publication details.</p>

        <!-- Nav Tabs for different input methods -->
        <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab" aria-controls="all" aria-selected="true">
                    üëÅÔ∏è View All Publications {% if publications or manual_publications %}<span class="badge bg-success">{{ publications|length + manual_publications|length }}</span>{% endif %}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab" aria-controls="upload" aria-selected="false">
                    üì§ Upload BibTeX File
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="paste-tab" data-bs-toggle="tab" data-bs-target="#paste" type="button" role="tab" aria-controls="paste" aria-selected="false">
                    üìã Paste BibTeX
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab" aria-controls="manual" aria-selected="false">
                    ‚úçÔ∏è Add Manually
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- View All Publications Tab -->
            <div class="tab-pane fade show active" id="all" role="tabpanel" aria-labelledby="all-tab">
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">All Publications</h5>
                    </div>
                    <div class="card-body">
                        {% if publications or manual_publications %}
                            <div class="list-group">
                                <!-- BibTeX Publications -->
                                {% for pub in publications %}
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <h6 class="mb-0">{{ pub.get('title', 'Untitled') }}</h6>
                                                    <span class="badge bg-info">From BibTeX</span>
                                                </div>
                                                {% if pub.get('author') %}
                                                    <p class="mb-1"><strong>Authors:</strong> {{ pub.get('author') }}</p>
                                                {% endif %}
                                                {% if pub.get('year') %}
                                                    <p class="mb-1"><strong>Year:</strong> {{ pub.get('year') }}</p>
                                                {% endif %}
                                                {% if pub.get('journal') %}
                                                    <p class="mb-1"><strong>Journal:</strong> {{ pub.get('journal') }}</p>
                                                {% endif %}
                                                {% if pub.get('volume') %}
                                                    <p class="mb-1"><strong>Volume:</strong> {{ pub.get('volume') }}</p>
                                                {% endif %}
                                                {% if pub.get('pages') %}
                                                    <p class="mb-1"><strong>Pages:</strong> {{ pub.get('pages') }}</p>
                                                {% endif %}
                                                {% if pub.get('doi') or pub.get('url') %}
                                                    <p class="mb-0">
                                                        {% if pub.get('doi') %}
                                                            <a href="https://doi.org/{{ pub.get('doi') }}" target="_blank" class="btn btn-sm btn-link">DOI</a>
                                                        {% endif %}
                                                        {% if pub.get('url') %}
                                                            <a href="{{ pub.get('url') }}" target="_blank" class="btn btn-sm btn-link">Link</a>
                                                        {% endif %}
                                                    </p>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <small class="text-muted">Read-only</small>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}

                                <!-- Manual Publications -->
                                {% for pub in manual_publications %}
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <h6 class="mb-0">{{ pub.title }}</h6>
                                                    <span class="badge bg-warning text-dark">Manual Entry</span>
                                                </div>
                                                <p class="mb-1"><strong>Authors:</strong> {{ pub.author }}</p>
                                                {% if pub.publication_year %}
                                                    <p class="mb-1"><strong>Year:</strong> {{ pub.publication_year }}</p>
                                                {% endif %}
                                                {% if pub.journal_or_booktitle %}
                                                    <p class="mb-1"><strong>Journal/Booktitle:</strong> {{ pub.journal_or_booktitle }}</p>
                                                {% endif %}
                                                {% if pub.publisher %}
                                                    <p class="mb-1"><strong>Publisher:</strong> {{ pub.publisher }}</p>
                                                {% endif %}
                                                {% if pub.doi or pub.url %}
                                                    <p class="mb-0">
                                                        {% if pub.doi %}
                                                            <a href="https://doi.org/{{ pub.doi }}" target="_blank" class="btn btn-sm btn-link">DOI</a>
                                                        {% endif %}
                                                        {% if pub.url %}
                                                            <a href="{{ pub.url }}" target="_blank" class="btn btn-sm btn-link">Link</a>
                                                        {% endif %}
                                                    </p>
                                                {% endif %}
                                            </div>
                                            <div class="btn-group" role="group">
                                                <a href="/wizard/{{ site.id }}/publication/{{ pub.id }}/edit" class="btn btn-sm btn-outline-primary">Edit</a>
                                                <form method="POST" action="/wizard/{{ site.id }}/publication/{{ pub.id }}/delete" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this publication?')">Delete</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info mb-0">
                                <strong>üìö No publications yet</strong>
                                <p class="mb-0">Add publications using one of the methods below.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Upload BibTeX File Tab -->
            <div class="tab-pane fade" id="upload" role="tabpanel" aria-labelledby="upload-tab">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Upload BibTeX File</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/wizard/{{ site.id }}/step/3" enctype="multipart/form-data" novalidate>
                            {{ form.hidden_tag() }}

                            <div class="form-group mb-3">
                                {{ form.bibtex_file.label(class="form-label") }}
                                {% if form.bibtex_file.errors %}
                                    {{ form.bibtex_file(class="form-control is-invalid") }}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.bibtex_file.errors %}{{ error }}<br>{% endfor %}
                                    </div>
                                {% else %}
                                    {{ form.bibtex_file(class="form-control", accept=".bib,.txt") }}
                                {% endif %}
                                <small class="form-text text-muted">Upload a .bib or .txt file containing BibTeX entries</small>
                            </div>

                            <button type="submit" name="upload" class="btn btn-info">Upload File</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Paste BibTeX Tab -->
            <div class="tab-pane fade" id="paste" role="tabpanel" aria-labelledby="paste-tab">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Paste BibTeX Content</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Paste your BibTeX entries below.</p>
                        
                        <form method="POST" action="/wizard/{{ site.id }}/step/3" novalidate>
                            {{ form.hidden_tag() }}

                            <div class="form-group mb-3">
                                {{ form.bibtex_content.label(class="form-label") }}
                                {% if form.bibtex_content.errors %}
                                    {{ form.bibtex_content(class="form-control is-invalid") }}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.bibtex_content.errors %}{{ error }}<br>{% endfor %}
                                    </div>
                                {% else %}
                                    {{ form.bibtex_content(class="form-control font-monospace") }}
                                {% endif %}
                                <small class="form-text text-muted">This field is optional. You can add publications now or skip this step.</small>
                            </div>

                            <div class="card bg-light mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">BibTeX Example:</h6>
                                </div>
                                <div class="card-body">
                                    <pre class="mb-0" style="font-size: 0.85rem;">@article{Smith2023,
  author={Smith, John and Doe, Jane},
  title={Revolutionary Discoveries in Science},
  journal={Journal of Important Research},
  year={2023},
  volume={42},
  pages={123-145},
  doi={10.1234/example}
}</pre>
                                </div>
                            </div>

                            {{ form.save_draft(class="btn btn-outline-primary") }}
                            {{ form.submit(class="btn btn-primary") }}
                        </form>
                    </div>
                </div>
            </div>

            <!-- Manual Entry Tab -->
            <div class="tab-pane fade" id="manual" role="tabpanel" aria-labelledby="manual-tab">
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Add Publication Manually</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Fill in the form below to add a single publication.</p>
                        
                        <form method="POST" action="/wizard/{{ site.id }}/publication/add" novalidate>
                            {{ manual_form.hidden_tag() }}

                            <div class="form-group mb-3">
                                {{ manual_form.author.label(class="form-label") }}
                                {% if manual_form.author.errors %}
                                    {{ manual_form.author(class="form-control is-invalid") }}
                                    <div class="invalid-feedback d-block">
                                        {% for error in manual_form.author.errors %}{{ error }}<br>{% endfor %}
                                    </div>
                                {% else %}
                                    {{ manual_form.author(class="form-control", placeholder="e.g., John Smith, Jane Doe") }}
                                {% endif %}
                            </div>

                            <div class="form-group mb-3">
                                {{ manual_form.title.label(class="form-label") }}
                                {% if manual_form.title.errors %}
                                    {{ manual_form.title(class="form-control is-invalid") }}
                                    <div class="invalid-feedback d-block">
                                        {% for error in manual_form.title.errors %}{{ error }}<br>{% endfor %}
                                    </div>
                                {% else %}
                                    {{ manual_form.title(class="form-control", placeholder="Publication title") }}
                                {% endif %}
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        {{ manual_form.publication_year.label(class="form-label") }}
                                        {% if manual_form.publication_year.errors %}
                                            {{ manual_form.publication_year(class="form-control is-invalid") }}
                                            <div class="invalid-feedback d-block">
                                                {% for error in manual_form.publication_year.errors %}{{ error }}<br>{% endfor %}
                                            </div>
                                        {% else %}
                                            {{ manual_form.publication_year(class="form-control", placeholder="2023") }}
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        {{ manual_form.publisher.label(class="form-label") }}
                                        {% if manual_form.publisher.errors %}
                                            {{ manual_form.publisher(class="form-control is-invalid") }}
                                            <div class="invalid-feedback d-block">
                                                {% for error in manual_form.publisher.errors %}{{ error }}<br>{% endfor %}
                                            </div>
                                        {% else %}
                                            {{ manual_form.publisher(class="form-control", placeholder="(Optional)") }}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                {{ manual_form.journal_or_booktitle.label(class="form-label") }}
                                {% if manual_form.journal_or_booktitle.errors %}
                                    {{ manual_form.journal_or_booktitle(class="form-control is-invalid") }}
                                    <div class="invalid-feedback d-block">
                                        {% for error in manual_form.journal_or_booktitle.errors %}{{ error }}<br>{% endfor %}
                                    </div>
                                {% else %}
                                    {{ manual_form.journal_or_booktitle(class="form-control", placeholder="Journal or Conference Name (Optional)") }}
                                {% endif %}
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        {{ manual_form.doi.label(class="form-label") }}
                                        {% if manual_form.doi.errors %}
                                            {{ manual_form.doi(class="form-control is-invalid") }}
                                            <div class="invalid-feedback d-block">
                                                {% for error in manual_form.doi.errors %}{{ error }}<br>{% endfor %}
                                            </div>
                                        {% else %}
                                            {{ manual_form.doi(class="form-control", placeholder="e.g., 10.1234/example") }}
                                        {% endif %}
                                        <small class="form-text text-muted">Optional</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        {{ manual_form.url.label(class="form-label") }}
                                        {% if manual_form.url.errors %}
                                            {{ manual_form.url(class="form-control is-invalid") }}
                                            <div class="invalid-feedback d-block">
                                                {% for error in manual_form.url.errors %}{{ error }}<br>{% endfor %}
                                            </div>
                                        {% else %}
                                            {{ manual_form.url(class="form-control", placeholder="https://...") }}
                                        {% endif %}
                                        <small class="form-text text-muted">Optional</small>
                                    </div>
                                </div>
                            </div>

                            {{ manual_form.submit(class="btn btn-warning") }}
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="d-flex gap-2 justify-content-between mt-4">
            <div>
                <a href="/wizard/{{ site.id }}/step/2" class="btn btn-secondary">Back</a>
            </div>
            <div>
                <a href="/wizard/{{ site.id }}/step/4" class="btn btn-primary">Next Step</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
